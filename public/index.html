<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Saferpay Payment Demo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 500px;
      margin: 40px auto;
      padding: 20px;
    }
    label {
      display: block;
      margin: 15px 0;
    }
    input {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      box-sizing: border-box;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
    }
    button:hover {
      background: #0056b3;
    }
    #output {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 5px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>

<h1>Enomfon Multi Media HUb Payment</h1>

<label>
  Amount (EUR):
  <input id="amount" type="number" step="0.01" min="0.50" value="10.00" />
  <small>Minimum: €0.50</small>
</label>

<label>
  Email (optional):
  <input id="email" type="email" placeholder="your@email.com" />
</label>

<button id="pay">Pay with Saferpay</button>

<div id="output"></div>

<script>
  const output = document.getElementById('output');
  const payButton = document.getElementById('pay');
  
  payButton.addEventListener('click', async () => {
    // Disable button to prevent double clicks
    payButton.disabled = true;
    payButton.textContent = 'Processing...';
    output.textContent = 'Creating payment...';
    output.style.color = 'black';
    
    const amountInput = document.getElementById('amount').value;
    const email = document.getElementById('email').value;
    
    // Validate amount
    if (!amountInput || Number(amountInput) < 0.50) {
      output.textContent = 'Please enter an amount of at least €0.50';
      output.style.color = 'red';
      payButton.disabled = false;
      payButton.textContent = 'Pay with Saferpay';
      return;
    }
    
    try {
      // Convert to cents and ensure it's a STRING
      const amountInCents = (Number(amountInput) * 100).toFixed(0);
      
      console.log('Sending amount to server:', amountInCents, typeof amountInCents);
      
      const response = await fetch('/api/payments/init', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({
          amount: amountInCents,  // This is now a STRING like "1000"
          email: email || undefined
        })
      });
      
      const responseText = await response.text();
      console.log('Server response:', responseText);
      
      if (!response.ok) {
        output.textContent = `Error: ${response.status}\n${responseText}`;
        output.style.color = 'red';
        payButton.disabled = false;
        payButton.textContent = 'Pay with Saferpay';
        return;
      }
      
      let data;
      try {
        data = JSON.parse(responseText);
      } catch (e) {
        output.textContent = `Invalid JSON response:\n${responseText}`;
        output.style.color = 'red';
        payButton.disabled = false;
        payButton.textContent = 'Pay with Saferpay';
        return;
      }
      
      if (data.redirectUrl) {
        console.log('Redirecting to:', data.redirectUrl);
        
        
        // Small delay for user to see message
        setTimeout(() => {
          window.location.href = data.redirectUrl;
        }, 1000);
        
      } else {
        output.textContent = `Unexpected response:\n${JSON.stringify(data, null, 2)}`;
        output.style.color = 'orange';
        payButton.disabled = false;
        payButton.textContent = 'Pay with Saferpay';
      }
      
    } catch (error) {
      console.error('Payment error:', error);
      output.textContent = `Network error: ${error.message}`;
      output.style.color = 'red';
      payButton.disabled = false;
      payButton.textContent = 'Try Again';
    }
  });
  
  // Also allow Enter key in amount field
  document.getElementById('amount').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      payButton.click();
    }
  });
</script>

</body>
</html>