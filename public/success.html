<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Payment Successful</title>
</head>
<body style="font-family: Arial, sans-serif; background:#f4f6f8; margin:0; padding:40px;">

  <div style="max-width:500px; margin:auto; background:#fff; padding:30px; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,.1); text-align:center;">
    <h1 style="color:#2ecc71;">Processing Paymentâ€¦</h1>
    <p id="message" style="font-size:16px;">Please wait while we confirm your payment.</p>
  </div>

  <script>
    const message = document.getElementById("message")
    const params = new URLSearchParams(window.location.search)
    const token = params.get("token")
    const orderId = params.get("orderId")
    const storedToken = orderId
      ? sessionStorage.getItem(`saferpay-token:${orderId}`)
      : null
    const resolvedToken = token || storedToken

    if (!resolvedToken) {
      message.textContent = "Missing payment token."
      message.style.color = "red"
    } else {
      fetch("/api/payments/assert", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token: resolvedToken })
      })
      .then(res => res.json())
      .then(async data => {
        if (!data.success) {
          message.textContent = "Payment verification failed."
          message.style.color = "red"
          return
        }

        const status = data.status

        if (status === "AUTHORIZED") {
          message.textContent = "Authorized. Capturing payment..."
          message.style.color = "#f39c12"

          const transactionId = data.transaction?.Id
          const amount = data.transaction?.Amount?.Value

          if (!transactionId || !amount) {
            message.textContent = "Missing capture details."
            message.style.color = "red"
            return
          }

          try {
            const captureRes = await fetch("/api/payments/capture", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ transactionId, amount })
            })

            const captureData = await captureRes.json()

            if (captureRes.ok && captureData.success) {
              message.textContent = "Payment captured. Redirecting to receipt..."
              message.style.color = "#2ecc71"
              if (captureData.redirectUrl) {
                setTimeout(() => {
                  window.location.href = captureData.redirectUrl
                }, 800)
              }
            } else {
              message.textContent = "Capture failed. Please contact support."
              message.style.color = "red"
            }
          } catch (err) {
            message.textContent = "Server error while capturing payment."
            message.style.color = "red"
          }
          return
        }

        if (status === "CAPTURED") {
          message.textContent = "Payment captured. Thank you!"
          message.style.color = "#2ecc71"
          return
        }

        if (status === "PENDING") {
          message.textContent = "Payment pending. We will update you shortly."
          message.style.color = "#f39c12"
          return
        }

        message.textContent = "Payment completed."
        message.style.color = "#2ecc71"
      })
      .catch(() => {
        message.textContent = "Server error while verifying payment."
        message.style.color = "red"
      })
    }
  </script>

</body>
</html>
